name: Version and Archive Overleaf PDF

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'builds/**'
      - '.github/**'

permissions:
  contents: write 

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect folder containing output.tex
        id: detect
        run: |
          latest=$(find . -type f -name "output.tex" -printf '%h\n' | sort | tail -n 1)
          latest="${latest#./}"
          if [ -z "$latest" ]; then
            echo "Could not find any folder with output.tex"
            exit 1
          fi
          echo "Detected Overleaf folder: $latest"
          echo "LATEST_PROJECT=$latest" >> $GITHUB_ENV

      - name: List detected folder contents
        run: |
          echo "Listing contents of ${{ env.LATEST_PROJECT }}"
          ls -lah "${{ env.LATEST_PROJECT }}"

      - name: Set version info
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> $GITHUB_ENV
          echo "\\newcommand{\\Version}{${{ env.SHORT_SHA }}-${{ env.BUILD_DATE }}}" > version.tex
          mv version.tex "${{ env.LATEST_PROJECT }}/version.tex"

      - name: Compile LaTeX document (skip bibtex)
        run: |
          cd "${{ env.LATEST_PROJECT }}"
          echo "Compiling output.tex in $(pwd)"
          latexmk -pdf -interaction=nonstopmode -file-line-error -halt-on-error -shell-escape -bibtex- --quiet output.tex || true

      - name: Archive compiled PDF
        run: |
          mkdir -p builds
          cp "${{ env.LATEST_PROJECT }}/output.pdf" "builds/manual-${{ env.SHORT_SHA }}.pdf"
          echo "Saved builds/manual-${{ env.SHORT_SHA }}.pdf"

      - name: Commit and push PDF
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add builds/
          git commit -m "Add compiled PDF for ${{ env.SHORT_SHA }}" || echo "No changes to commit"
          git push origin HEAD:main
