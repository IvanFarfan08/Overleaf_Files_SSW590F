name: Version and Archive Overleaf PDF

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'builds/**'
      - '.github/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed Overleaf folder from last commit
        id: detect
        run: |
          latest=$(git diff-tree --no-commit-id --name-only -r HEAD | head -n 1 | cut -d'/' -f1)
          echo "Detected folder from last commit: $latest"
          echo "LATEST_PROJECT=$latest" >> $GITHUB_ENV

      - name: Verify folder and list contents
        run: |
          echo "Checking folder: ${{ env.LATEST_PROJECT }}"
          ls -lah ${{ env.LATEST_PROJECT }} || echo "⚠️ Folder not found"

      - name: Set version info
        id: version
        run: |
          echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date -u +'%Y-%m-%dT%H-%M-%SZ')" >> $GITHUB_ENV
          echo "\\newcommand{\\Version}{${{ env.SHORT_SHA }}-${{ env.BUILD_DATE }}}" > version.tex
          mv version.tex "${{ env.LATEST_PROJECT }}/version.tex"

      - name: Compile LaTeX document
        uses: xu-cheng/latex-action@v3
        with:
          root_file: output.tex
          working_directory: ${{ env.LATEST_PROJECT }}
          work_in_root_file_dir: true
          args: -pdf -interaction=nonstopmode -file-line-error -halt-on-error -shell-escape

      - name: Archive compiled PDF
        run: |
          mkdir -p builds
          cp "${{ env.LATEST_PROJECT }}/output.pdf" "builds/manual-${{ env.SHORT_SHA }}.pdf"
          echo "Saved builds/manual-${{ env.SHORT_SHA }}.pdf"

      - name: Commit and push PDF
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add builds/
          git commit -m "Add compiled PDF for ${{ env.SHORT_SHA }}" || echo "No changes to commit"
          git push
