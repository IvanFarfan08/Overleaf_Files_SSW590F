name: Version and Archive Overleaf PDF

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'builds/**'
      - '.github/**'

permissions:
  contents: write 

jobs:
  build:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if triggered by workflow commit
        id: check_commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == "Add compiled PDF for"* ]]; then
            echo "Skipping: This commit was created by the workflow"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract project folder from commit message
        if: steps.check_commit.outputs.skip != 'true'
        id: detect
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Try format 1: "export: FOLDER_ID @ timestamp"
          FOLDER_ID=$(echo "$COMMIT_MSG" | sed -n 's/^export: \([^ ]*\) @.*/\1/p')

          # If that fails, try format 2: "overleaf-export: ... (FOLDER_ID)"
          if [ -z "$FOLDER_ID" ]; then
            FOLDER_ID=$(echo "$COMMIT_MSG" | sed -n 's/.*(\(.*\)).*/\1/p')
          fi

          if [ -z "$FOLDER_ID" ]; then
            echo "Could not extract folder ID from commit message"
            exit 1
          fi

          if [ ! -d "$FOLDER_ID" ]; then
            echo "Folder $FOLDER_ID does not exist"
            exit 1
          fi

          echo "Detected Overleaf folder: $FOLDER_ID"
          echo "LATEST_PROJECT=$FOLDER_ID" >> $GITHUB_ENV

      - name: List detected folder contents
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          echo "Listing contents of ${{ env.LATEST_PROJECT }}"
          ls -lah "${{ env.LATEST_PROJECT }}"

      - name: Detect root LaTeX file
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          if [ -f "${{ env.LATEST_PROJECT }}/output.tex" ]; then
            ROOT_FILE="output.tex"
          elif [ -f "${{ env.LATEST_PROJECT }}/main.tex" ]; then
            ROOT_FILE="main.tex"
          else
            echo "Error: Neither output.tex nor main.tex found in ${{ env.LATEST_PROJECT }}"
            exit 1
          fi
          echo "Detected root file: $ROOT_FILE"
          echo "ROOT_FILE=$ROOT_FILE" >> $GITHUB_ENV

      - name: Generate version.tex
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H-%M-%SZ')
          TARGET_FILE="${{ env.LATEST_PROJECT }}/version.tex"
          echo "\\newcommand{\\Version}{$SHORT_SHA-$BUILD_DATE}" > "$TARGET_FILE"
          echo "Generated $TARGET_FILE:"
          cat "$TARGET_FILE"
          # Export commit SHA for later PDF naming
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV

      - name: Compile LaTeX document
        if: steps.check_commit.outputs.skip != 'true'
        uses: xu-cheng/latex-action@v3
        with:
          working_directory: ${{ env.LATEST_PROJECT }}
          root_file: ${{ env.ROOT_FILE }}
          latexmk_shell_escape: true
          args: -pdf -interaction=nonstopmode -f --quiet -jobname=compile
          continue_on_error: true

      - name: Archive compiled PDF
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          mkdir -p builds
          cp "${{ env.LATEST_PROJECT }}/compile.pdf" "builds/manual-${{ env.SHORT_SHA }}.pdf"
          echo "Saved builds/manual-${{ env.SHORT_SHA }}.pdf"

      - name: Commit and push PDF
        if: steps.check_commit.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Action"
          git config user.email "actions@github.com"
          git add builds/
          git commit -m "Add compiled PDF for ${{ env.SHORT_SHA }}" || echo "No changes to commit"
          git push origin HEAD:main
